// $('#chat-messages')[0].childElementCount

var RGame = {
	'debug': true, // enable debug messages in console
//	'chat_limit': 7, // count of messsage after first message will be deleted; false to not use
	'chat_messages': [], // all messages are stored there
};

RGame.log = function(data) {
	if(RGame.debug != true)
		return;
	
	console.log(data);
}

RGame.sendchat = function() {
	if( $('#chat-message')[0].value.length <= 0 )
		return;
	
	// TODO: chat

	$('#chat-message')[0].value = '';
}

RGame.getOnline = function(el) {
	$.getJSON('/api/method/auth.setonline', {'id': sessionStorage.getItem('char'), 'player': sessionStorage.getItem('id'), 'token': sessionStorage.getItem('token')}, 
	function(data) { });
	
	$.getJSON('/api/method/auth.online', {}, function(data) {
		if(el) {
			el.innerHTML = '';
			$.each(data, function(k, v) {
				el.innerHTML += '<li>' + k + '</li>';
			});
		}
		
		RGame.lastOnline = data;
	});
}

RGame.prepare = function() {
	Notification.requestPermission(function(permission){
		RGame.notifyEnabled = (permission == 'granted') ? true : false;
		RGame.log('Notifications permission: ' + permission);
	});
	
	RGame.getOnline( $('#character-list')[0]);
	setInterval(function() {
		RGame.getOnline( $('#character-list')[0] );
	}, 120000);
};
	
RGame.gotMessage = function(data) {
	if( $('#chat-messages').length <= 0 )
		return;
	
	msg = document.createElement('p');
	msg.innerHTML = '<small><b>' + data.sender_name + '</b>: ' + data.message + '</small>';
	$('#chat-messages')[0].contentDocument.body.appendChild(msg);
	
	 $('#chat-messages')[0].contentWindow.scrollBy(0, 10000000)
	
/*	if( RGame.chat_limit != false && $('#chat-messages')[0].childElementCount > RGame.chat_limit ) {
		$('#chat-messages')[0].children[0].remove();
	} 
*/
};

$(document).ready( function() { RGame.prepare(); } );